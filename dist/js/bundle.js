class A{_divElement;_lines;_maxLines;constructor(J){this._divElement=J,this._divElement.innerHTML="",this._lines=[],this._maxLines=30}log(...J){if(J.length==0)return;const _=Array.prototype.slice.call(J).join(" ");console.log(_),this._pushText(_)}error(...J){if(J.length==0)return;const _=Array.prototype.slice.call(J).join(" ");console.error(_),this._pushText(`[ERR] - ${_}`)}_pushText(J){if(this._lines.push(J),this._lines.length>this._maxLines)this._lines.splice(0,this._lines.length-this._maxLines);this._divElement.innerHTML=this._lines.map((_)=>{if(/^(\[JS\]).*$/.test(_))return`<span style="color: rgb(200,200,150);">${_}</span>`;if(/^(\[C\+\+\]).*$/.test(_))return`<span style="color: rgb(150,150,200);">${_}</span>`;return _}).join("<br>"),this._divElement.scrollTop=this._divElement.scrollHeight}get size(){return this._lines.length}peekLast(){if(this._lines.length>0)return this._lines[this._lines.length-1];return}popLast(){if(this._lines.length>0)this._lines.splice(this._lines.length-1,1)}}var G=A;var E=/[?&]+([^=&]+)=([^&]*)/gi,I=()=>{const J={};let _=null;while(_=E.exec(window.location.href)){const D=_[1],Q=_[2];J[D]=Q}return J};var f=(J)=>{return new Promise((_,D)=>{const Q=document.createElement("script");Q.src=J,Q.addEventListener("load",()=>_()),Q.addEventListener("error",(K)=>D(K)),document.head.appendChild(Q)})};var B=(J)=>{if(!window.WebGL2RenderingContext)throw new Error("missing WebGL2 feature (unsuported)");const _={alpha:!1,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!1},D=J.getContext("webgl2",_);if(!D)throw new Error("WebGL2 context failed (initialisation)");return D};var S=()=>{return(()=>{try{if(typeof WebAssembly==="object"&&typeof WebAssembly.instantiate==="function"){const _=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(_ instanceof WebAssembly.Module)return new WebAssembly.Instance(_)instanceof WebAssembly.Instance}}catch(_){}return!1})()};var w=()=>{return!!window.Worker};var F=()=>{return!!window.WebGL2RenderingContext};var C=()=>{const J=window.SharedArrayBuffer!==void 0;if(J){const D={initial:8,maximum:8,shared:!0};if(!(new WebAssembly.Memory(D).buffer instanceof SharedArrayBuffer))return!1}return J};class W{_canvas;_webglCtx;_width=800;_height=600;_isInitialized=!1;_isAborted=!1;_wasmApplicationStartFunc;_wasmApplicationUpdateFunc;_wasmApplicationRenderFunc;_onProgress;_onError;_module;constructor(J,_,D){this._canvas=J,this._onProgress=_,this._onError=D}async initialize(J,_,D,Q,K){if(this._width=J,this._height=_,!w())throw new Error("missing WebWorker feature (unsupported)");if(K.log("[JS][check] WebWorker feature => supported"),!S())throw new Error("missing WebAssembly feature (unsupported)");K.log("[JS][check] WebAssembly feature => supported");const z=C();if(z)K.log("[JS][check] multithreading => supported");else K.log("[JS][check] multithreading => NOT supported"),K.log("[JS][check] => falling back to the webworker version");if(!F())throw new Error("missing WebGL2 feature (unsupported)");K.log("[JS][check] WebGL2 feature => supported");const Z=()=>{if(this._isAborted=!0,this._onError)this._onError("Could not create a WebGL2 context.")};this._canvas.addEventListener("webglcontextcreationerror",Z,!1);const $=()=>{if(this._isAborted=!0,this._onError)this._onError("WebGL2 context lost. You will need to reload the page.")};this._canvas.addEventListener("webglcontextlost",$,!1);const X=(k)=>{k.preventDefault()};this._canvas.addEventListener("contextmenu",X,!1),this._webglCtx=B(this._canvas),K.log("[JS] WebGL2 context initialized"),await this._setupWasmApplication(z,D,Q,K)}async _fetchWasmScript(J,_){_.log("[JS][wasm] fetching");const D=Date.now();await f(`./${J}/index.js`);const K=((Date.now()-D)/1000).toFixed(3);_.log(`[JS][wasm] fetched ${K}sec`)}async _loadWasmApplication(J,_){_.log("[JS] loading");const D=Date.now(),Q=/Downloading data\.\.\. \(([0-9]*)\/([0-9]*)\)/;let K=0;const z={locateFile:(X)=>`${J}/${X}`,print:(X)=>{_.log(`[C++][out] ${X}`)},printErr:(X)=>{_.error(`[C++][err] ${X}`)},setStatus:(X)=>{if(!X)return;const k=Q.exec(X);if(!k){_.log(`[JS][wasm][status] ${X}`);return}const y=parseFloat(k[1]),H=parseFloat(k[2]),R=Math.floor(y/H*100);if(K===R)return;K=R,this._onProgress(R)},onRuntimeInitialized:()=>{_.log("[JS][wasm] runtime initialized")},canvas:this._canvas,preinitializedWebGLContext:this._webglCtx,noInitialRun:!0,noExitRuntime:!0};this._module=await selfDriving3dCars(z);const $=((Date.now()-D)/1000).toFixed(3);_.log(`[JS] loaded ${$}sec`)}_initializeWasmApplication(J){J.log("[JS][wasm] initializing");const _=Date.now(),D={startApplication:this._module.cwrap("startApplication",void 0,["number","number","number","number"]),updateApplication:this._module.cwrap("updateApplication",void 0,["number"]),renderApplication:this._module.cwrap("renderApplication",void 0,[])};this._wasmApplicationStartFunc=D.startApplication,this._wasmApplicationUpdateFunc=D.updateApplication,this._wasmApplicationRenderFunc=D.renderApplication,this._isInitialized=!0;const K=((Date.now()-_)/1000).toFixed(3);J.log(`[JS][wasm] initialized ${K}sec`)}async _setupWasmApplication(J,_,D,Q){const K=`wasm/${J?"pthread":"webworker"}`;await this._fetchWasmScript(K,Q),await this._loadWasmApplication(K,Q),this._initializeWasmApplication(Q),Q.log("[JS][wasm] running"),this._wasmApplicationStartFunc(this._width,this._height,_,D)}update(J){if(!this._isInitialized||this._isAborted)return;if(this._wasmApplicationUpdateFunc)this._wasmApplicationUpdateFunc(J)}render(){if(!this._isInitialized||this._isAborted)return;if(this._wasmApplicationRenderFunc)this._wasmApplicationRenderFunc()}abort(){if(!this._isInitialized||this._isAborted)return;if(this._isAborted=!0,!this._module)return;this._module.setStatus=(J)=>{if(J)console.error(`[JS][wasm][aborted] ${J}`)}}}var M=(J)=>{const _=document.querySelector(J);if(!_)throw new Error(`DOM elements not found, id=${J}`);return _},h=async()=>{let J=!0;const _=M("#loggerOutput"),D=new G(_);D.log("[JS] page loaded");const Q=(q)=>{J=!1,D.error(`[JS] exception, message=${q.message}`)};window.addEventListener("error",Q);const K=M("#errorText"),z=M("#renderArea"),Z=M("#canvas"),$={switchTo3cpuCores:M("#try_with_3_cpu_cores"),switchTo6cpuCores:M("#try_with_6_cpu_cores")},X=(q)=>{if(q.style.display!=="none")q.style.display="none"},k=(q)=>{if(q.style.display!=="block")q.style.display="block"},y=(q)=>{K.innerHTML=q,X(Z),k(K)},H=()=>{X(K),k(Z)},R=(q,Y)=>{z.style.maxWidth=Z.style.maxWidth=`${q}px`,z.style.maxHeight=Z.style.maxHeight=`${Y}px`,Z.width=q,Z.height=Y},T=(q)=>{Q(q),y(`fatal error, event=${q}`)};window.removeEventListener("error",Q),window.addEventListener("error",T);const U=(q,Y)=>q?parseInt(q,10):Y,N=I(),j={width:U(N.width,800),height:U(N.height,600),totalGenomes:U(N.totalGenomes,1000),totalCores:U(N.totalCores,3)};R(j.width,j.height);const P=(q,Y,v)=>{if(q.disabled=!1,!q.classList.contains(Y))q.classList.add(Y);if(q.classList.contains("grayButton"))q.classList.remove("grayButton");q.addEventListener("click",()=>{window.location.href=window.location.pathname+`?totalCores=${v}`})};if(j.totalCores!=3)$.switchTo6cpuCores.disabled=!0,P($.switchTo3cpuCores,"blueButton",3);else $.switchTo3cpuCores.disabled=!0,P($.switchTo6cpuCores,"redButton",6);const O=new W(Z,(q)=>{const Y=`Loading wasm [${q}%]`;if(D.size>0&&D.peekLast().indexOf("Loading wasm [")>=0)D.popLast();D.log(`[JS] ${Y}`),y(Y)},y);try{await O.initialize(j.width,j.height,j.totalGenomes,j.totalCores,D),H()}catch(q){D.error(`[JS] dependencies check failed: message="${q.message}"`),y(["this browser isn't compatible","error message:",`=> ${q.message}`].join("<br>"))}let V=Date.now();const b=()=>{if(J)requestAnimationFrame(b);const q=Date.now(),Y=q-V;V=q,O.update(Y),O.render()};b()};window.addEventListener("load",h);
